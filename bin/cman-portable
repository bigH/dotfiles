#!/bin/bash

# -- portable sh_utils --

RED="$(tput setaf 1)"
GREEN="$(tput setaf 2)"
YELLOW="$(tput setaf 3)"
BLUE="$(tput setaf 4)"
CYAN="$(tput setaf 6)"
GRAY="$(tput setaf 8)"
BOLD="$(tput bold)"
NORMAL="$(tput sgr0)"

log_error() {
  echo "[${RED}${BOLD}ERROR${NORMAL}] $*"
}

log_info() {
  echo "[${GREEN}${BOLD}INFO${NORMAL}] $*"
}

join_lines() {
  DEFAULT_SEP=' '
  SEP="${1:-$DEFAULT_SEP}"
  LENGTH_OF_SEP="${#SEP}"

  if [ "$LENGTH_OF_SEP" -eq 0 ]; then
    paste -s -d' ' -
  elif [ "$LENGTH_OF_SEP" -eq 1 ]; then
    paste -s -d"$SEP" -
  else
    paste -s -d"%" - | sed "s/%/$SEP/g"
  fi
}

awk_with_color_codes() {
  awk \
    -v RED="$RED" \
    -v GREEN="$GREEN" \
    -v YELLOW="$YELLOW" \
    -v BLUE="$BLUE" \
    -v CYAN="$CYAN" \
    -v GRAY="$GRAY" \
    -v BOLD="$BOLD" \
    -v NORMAL="$NORMAL" \
    "$@"
}

# -- cman --

ACTIVE_DIR="$WORK_DIR_PATH"
FREEZER_DIR="${WORK_DIR_PATH}-freezer"
MAX_DIR_NAME_LENGTH=32

mkdir -p "$FREEZER_DIR"

if [ ! -d "$ACTIVE_DIR" ]; then
  log_error "\$WORK_DIR_PATH is not a directory: $ACTIVE_DIR"
  exit 1
fi

active_dirs() {
  (cd "$ACTIVE_DIR" && ls -d -1 */ 2>/dev/null | grep -v halo | sed 's|/$||')
}

frozen_dirs() {
  (cd "$FREEZER_DIR" && ls -d -1 */ 2>/dev/null | grep -v halo | sed 's|/$||')
}

ACTIVE_LIST="$(active_dirs)"
FROZEN_LIST="$(frozen_dirs)"

if [ -z "$ACTIVE_LIST" ] && [ -z "$FROZEN_LIST" ]; then
  log_info "No directories found."
  exit 0
fi

# sorted view: all dirs interleaved alphabetically
SORTED_FILE="$(mktemp)"
comm <(echo "$ACTIVE_LIST" | sort) <(echo "$FROZEN_LIST" | sort) | \
  awk_with_color_codes -v w="$MAX_DIR_NAME_LENGTH" '
    /^\t/ { name = substr($0, 2); printf "%-*s %s%s%s\n", w, name, BLUE, "[frozen]", NORMAL; next }
    NF    { print BOLD $0 NORMAL }
  ' > "$SORTED_FILE"

# grouped view: active first, then frozen
GROUPED_FILE="$(mktemp)"
{
  echo "$ACTIVE_LIST" | awk_with_color_codes 'NF { print BOLD $0 NORMAL }'
  echo "$FROZEN_LIST" | awk_with_color_codes -v w="$MAX_DIR_NAME_LENGTH" 'NF { printf "%-*s %s%s%s\n", w, $0, BLUE, "[frozen]", NORMAL }'
} > "$GROUPED_FILE"

TOGGLE_STATE="$(mktemp)"
trap 'rm -f "$SORTED_FILE" "$GROUPED_FILE" "$TOGGLE_STATE"' EXIT

# pre-select active dirs via query + select-all trick
PRESELECT_QUERY="$(echo "$ACTIVE_LIST" | sed 's/.*$/^&$/' | join_lines ' | ')"

HEADER='
'"${GRAY}(Ctrl+S toggle sort)${NORMAL}"'
 '

FZF_OUTPUT="$(
  cat "$SORTED_FILE" | \
    fzf --ansi --no-height --multi \
        --nth 1 \
        --header "$HEADER" \
        --query "$PRESELECT_QUERY" \
        --bind 'load:select-all+clear-query' \
        --bind "ctrl-s:reload(if [ -f $TOGGLE_STATE ]; then rm $TOGGLE_STATE; cat $GROUPED_FILE; else touch $TOGGLE_STATE; cat $SORTED_FILE; fi)+change-query($PRESELECT_QUERY)+select-all+clear-query" \
        --preview "eza -l --color=always $ACTIVE_DIR/{1} 2>/dev/null || eza -l --color=always $FREEZER_DIR/{1} 2>/dev/null"
)"

if [ $? -ne 0 ]; then
  exit 0
fi

# strip ANSI codes and extract directory name (first field)
SELECTED="$(echo "$FZF_OUTPUT" | sed $'s/\x1b\\[[0-9;]*m//g' | awk '{ print $1 }')"

# activate: selected items currently in freezer
echo "$FROZEN_LIST" | while read -r name; do
  [ -z "$name" ] && continue
  if echo "$SELECTED" | grep -qxF "$name"; then
    log_info "Activating ${GREEN}${BOLD}$name${NORMAL}"
    mv "$FREEZER_DIR/$name" "$ACTIVE_DIR/$name"
  fi
done

# freeze: deselected items currently active
echo "$ACTIVE_LIST" | while read -r name; do
  [ -z "$name" ] && continue
  if ! echo "$SELECTED" | grep -qxF "$name"; then
    log_info "Freezing ${YELLOW}${BOLD}$name${NORMAL}"
    mv "$ACTIVE_DIR/$name" "$FREEZER_DIR/$name"
  fi
done
